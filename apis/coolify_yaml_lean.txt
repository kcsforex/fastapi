version: "3.8"
services:
  n8n:
    image: 'docker.n8n.io/n8nio/n8n:1.123.5'
    build:
      context: .
      dockerfile_inline: |
        FROM docker.n8n.io/n8nio/n8n:1.123.5

        WORKDIR /home/node
        USER root

        RUN apk add --update --no-cache \
            python3 py3-pip python3-dev build-base gcc musl-dev linux-headers \
            && ln -sf /usr/bin/python3 /usr/bin/python

        RUN pip3 install --no-cache-dir --break-system-packages \
            requests pandas numpy ccxt yfinance beautifulsoup4 pyarrow selenium

        RUN mkdir -p /home/node/.n8n && \
            chown -R node:node /home/node/.n8n && \
            chmod 700 /home/node/.n8n

        ENV PYTHON_PATH=/usr/bin/python3 \
            PYTHONUNBUFFERED=1 \
            NODE_FUNCTION_ALLOW_BUILTIN=* \
            NODE_FUNCTION_ALLOW_EXTERNAL=*

        EXPOSE 5678
        USER node

    environment:
      N8N_ENCRYPTION_KEY: ${N8N_ENCRYPTION_KEY}
      SERVICE_URL_N8N: ${SERVICE_URL_N8N}
      N8N_EDITOR_BASE_URL: ${SERVICE_URL_N8N}
      WEBHOOK_URL: ${SERVICE_URL_N8N}
      N8N_HOST: ${SERVICE_URL_N8N}
      N8N_PROTOCOL: https
      N8N_PORT: 5678
      TZ: ${TZ:-Europe/Berlin}
      GENERIC_TIMEZONE: ${GENERIC_TIMEZONE:-Europe/Berlin}

      # --- PERSISTENCE & CLEANUP ---
      # Only save data if a workflow fails (saves massive DB space during testing)
      EXECUTIONS_DATA_SAVE_ON_SUCCESS: none
      # Automatically delete old execution history
      EXECUTIONS_DATA_PRUNE: "true"
      # Keep history for 48 hours only (perfect for learning/debugging)
      EXECUTIONS_DATA_MAX_AGE: 48
      
      # --- PERFORMANCE FOR 8GB RAM ---
      # Allow n8n to handle much larger data chunks (up to 256MB)
      N8N_PAYLOAD_SIZE_MAX: 268435456
      # Give the Node.js engine more "breathing room" (use half of your 8GB)
      NODE_OPTIONS: "--max-old-space-size=4096"

      DB_TYPE: postgresdb
      DB_POSTGRESDB_HOST: postgresql
      DB_POSTGRESDB_PORT: 5432
      DB_POSTGRESDB_DATABASE: ${POSTGRES_DB:-n8n}
      DB_POSTGRESDB_USER: ${SERVICE_USER_POSTGRES}
      DB_POSTGRESDB_PASSWORD: ${SERVICE_PASSWORD_POSTGRES}
      DB_POSTGRESDB_SCHEMA: public
      N8N_RUNNERS_ENABLED: true
      N8N_BLOCK_ENV_ACCESS_IN_NODE: true
      N8N_GIT_NODE_DISABLE_BARE_REPOS: true
      N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS: true
      N8N_PROXY_HOPS: 1

    volumes:
      - n8n-data:/home/node/.n8n

    depends_on:
      postgresql:
        condition: service_healthy

    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:5678/"]
      interval: 60s
      timeout: 10s
      retries: 3

  postgresql:
    image: postgres:16-alpine
    volumes:
      - postgresql-data:/var/lib/postgresql/data
    environment:
      POSTGRES_USER: ${SERVICE_USER_POSTGRES}
      POSTGRES_PASSWORD: ${SERVICE_PASSWORD_POSTGRES}
      POSTGRES_DB: ${POSTGRES_DB:-n8n}
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER} -d $${POSTGRES_DB}"]
      interval: 60s
      timeout: 10s
      retries: 3

volumes:
  n8n-data:
  postgresql-data:
